<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>LoRa Receiver – Automatic Frequency Control | StuartsProjects</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="LoRa Receiver – Automatic Frequency Control" />
<meta name="author" content="Stuart" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="The maximum permitted frequency error between transmitter and receiver, for reception of a LoRa packet, is 25% of the bandwidth in use. So at 125000hz bandwidth the maximum frequency error is 31500hz, if the bandwidth is 7800hz the maximum frequency error is 1950hz. One of the benefits of the earlier LoRa devices, the SX127X family, was that working products or modules could be made using relatively low cost crystals for the oscillator." />
<meta property="og:description" content="The maximum permitted frequency error between transmitter and receiver, for reception of a LoRa packet, is 25% of the bandwidth in use. So at 125000hz bandwidth the maximum frequency error is 31500hz, if the bandwidth is 7800hz the maximum frequency error is 1950hz. One of the benefits of the earlier LoRa devices, the SX127X family, was that working products or modules could be made using relatively low cost crystals for the oscillator." />
<link rel="canonical" href="http://localhost:4000/2020/06/11/LoRa-receiver-automatic-frequency-control.html" />
<meta property="og:url" content="http://localhost:4000/2020/06/11/LoRa-receiver-automatic-frequency-control.html" />
<meta property="og:site_name" content="StuartsProjects" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-06-11T00:00:00+01:00" />
<script type="application/ld+json">
{"url":"http://localhost:4000/2020/06/11/LoRa-receiver-automatic-frequency-control.html","author":{"@type":"Person","name":"Stuart"},"headline":"LoRa Receiver – Automatic Frequency Control","dateModified":"2020-06-11T00:00:00+01:00","datePublished":"2020-06-11T00:00:00+01:00","description":"The maximum permitted frequency error between transmitter and receiver, for reception of a LoRa packet, is 25% of the bandwidth in use. So at 125000hz bandwidth the maximum frequency error is 31500hz, if the bandwidth is 7800hz the maximum frequency error is 1950hz. One of the benefits of the earlier LoRa devices, the SX127X family, was that working products or modules could be made using relatively low cost crystals for the oscillator.","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2020/06/11/LoRa-receiver-automatic-frequency-control.html"},"@type":"BlogPosting","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="StuartsProjects" />
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">StuartsProjects</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/Contact.html">Contact</a><a class="page-link" href="/Products.html">Products</a><a class="page-link" href="/WhatisLora.html">What Is LoRa ?</a><a class="page-link" href="/about.html">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">LoRa Receiver – Automatic Frequency Control</h1>
    <p class="post-meta"><time class="dt-published" datetime="2020-06-11T00:00:00+01:00" itemprop="datePublished">
        Jun 11, 2020
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>The maximum permitted frequency error between transmitter and receiver, for reception of a LoRa packet, is 25% of the bandwidth in use. 
So at 125000hz bandwidth the maximum frequency error is 31500hz, if the bandwidth is 7800hz the maximum frequency error is 1950hz. 
One of the benefits of the earlier LoRa devices, the SX127X family, was that working products or modules could be made using relatively low cost crystals for the oscillator.</p>

<p>A typical variation seen in 434Mhz modules from Hope or Dorji for example was that there could be a variation of up to +\- 4000hz frequency difference when transmitter and receiver modules were at room temperature, so up to 8000hz between transmitter and receiver.</p>

<p>As the bandwidth is lowered, then so the receiver sensitivity increases resulting in longer range capability. In some countries you can use 100% duty cycle below 25000hz channels, so there are benefits in using lower bandwidths.</p>

<p>At 434Mhz and a bandwidth of 20800hz, then the transmitter and receiver must be no more than 5200hz apart which is outside the possible limits mentioned above. You might get two devices communicating ‘out of the box’ when at the same temperature at this low bandwidth but then you might not. If there are also significant temperature differences between devices this can increase the frequency differences too.</p>

<p>One possible solution is to calibrate each transmitter and receiver such that by using a suitable calibration offset the different devices at least start out at the same frequency. The SX12XX library allows for this in that the frequency of the modules is set with this function;</p>

<p>setRfFrequency(Frequency, Offset);</p>

<p>So you can set modules to the same target frequency and compensate with a calibration value in Offset. There is a program in the SX127x library \examples folder that makes the LoRa device put out a carrier so its easy to measure the actual output frequency. Lets imagine that we want to operate on 434Mhz and a particular module when set for that when measured with a frequency counter is transmitting on 434002000hz, or 2000hz higher than desired. That module would then be setup with;</p>

<p>setRfFrequency(434000000, -2000);</p>

<p>So it now outputs on 434000000hz.</p>

<h3 id="automatic-frequency-control">Automatic Frequency Control</h3>

<p>There is another partial solution to dealing with these frequency differences between devices at low bandwidths, you can use a form of automatic frequency correction (AFC). When a packet is received the LoRa receiver will produce an estimate of the frequency difference between the transmitted packet and the frequency the receiver is operating on. This frequency error is stored in 3 device registers and we can read it out. You can then use the frequency error to adjust the frequency of the receiver.</p>

<p>You might have an initial frequency error of 2000hz and AFC can reduce it to 100hz or so. However whilst the AFC functionality can keep transmitter and receiver close together when reception is working, if the transmitter and receiver are to far apart in frequency for reception to work in the first place then AFC cannot operate to correct for the frequency differences. Some form of manual intervention is needed to allow reception to start, possibly by initiating communication initially at a higher bandwidth.</p>

<p>The AFC functionality has been added to the SX127xx library, just call the function doAFC(); after a valid packet reception.</p>

<h3 id="errors-with-frequency-error-value">Errors with frequency error value</h3>

<p>The AFC is not without issues however. It was noticed in testing the AFC (see example program 73_LoRa_Receiver_AFC) that occasionally the frequency error would jump by 1000hz or so, I was testing at bandwidth 125000hz SF7. Below is a copy of the test program printout that shows the problem;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>351s  Hello World 1234567890*,0,3E,C0,Regval,3EC0,FreqErrror,2105hz
352s  Hello World 1234567890*,0,3E,C0,Regval,3EC0,FreqErrror,2105hz
353s  Hello World 1234567890*,0,3E,C0,Regval,3EC0,FreqErrror,2105hz
354s  Hello World 1234567890*,0,3E,C0,Regval,3EC0,FreqErrror,2105hz
355s  Hello World 1234567890*,0,3E,C0,Regval,3EC0,FreqErrror,2105hz
356s  Hello World 1234567890*,0,3E,C0,Regval,3EC0,FreqErrror,2105hz
357s  Hello World 1234567890*,0,3E,C0,Regval,3EC0,FreqErrror,2105hz
358s  Hello World 1234567890*,0,3E,C0,Regval,3EC0,FreqErrror,2105hz
359s  Hello World 1234567890*,0,3E,C0,Regval,3EC0,FreqErrror,2105hz
360s  Hello World 1234567890*,0,3E,C0,Regval,3EC0,FreqErrror,2105hz
361s  Hello World 1234567890*,0,3E,C0,Regval,3EC0,FreqErrror,2105hz
362s  Hello World 1234567890*,0,5E,C0,Regval,5EC0,FreqErrror,3179hz
363s  Hello World 1234567890*,0,3E,C0,Regval,3EC0,FreqErrror,2105hz
365s  Hello World 1234567890*,0,3E,C0,Regval,3EC0,FreqErrror,2105hz
366s  Hello World 1234567890*,0,5E,C0,Regval,5EC0,FreqErrror,3179hz
367s  Hello World 1234567890*,0,3E,C0,Regval,3EC0,FreqErrror,2105hz
368s  Hello World 1234567890*,0,3E,C0,Regval,3EC0,FreqErrror,2105hz
369s  Hello World 1234567890*,0,3E,C0,Regval,3EC0,FreqErrror,2105hz
370s  Hello World 1234567890*,0,3E,C0,Regval,3EC0,FreqErrror,2105hz
371s  Hello World 1234567890*,0,3E,C0,Regval,3EC0,FreqErrror,2105hz
372s  Hello World 1234567890*,0,3E,C0,Regval,3EC0,FreqErrror,2105hz
373s  Hello World 1234567890*,0,3E,C0,Regval,3EC0,FreqErrror,2105hz
374s  Hello World 1234567890*,0,5E,C0,Regval,5EC0,FreqErrror,3179hz
</code></pre></div></div>

<p>The printout shows the time on the left then the packet contents received. Then the 3 individual frequency error registers, REG_FEIMSB, REG_FEIMID and REG_FEILSB. Then the frequency error registers as a combined HEX number and finally the calculated frequency error in hertz. You will note that the frequency error seems very stable at 2105hz with the frequency error registers at 0x3EC0.</p>

<p>However, note that bit 2 of REG_FEIMID is randomly set to logic 1, so the HEX registry value changes to 0x5EC0.  This randomness of bit 2 of REG_FEIMID is not caused by the transmitter shifting in frequency, two receivers were operated receiving the same packets and they both exhibited the same issue, but not for the same packet or at the same time.</p>

<p>It does not appear to be a hardware issue reading the SPI bus, note that the received packet is always displayed without error. Also there are 3 separate reads of the frequency error register contents, first to display 0,5E,C0, then to display Regval, 5EC0 and finally to display FreqErrror,3179hz. All 3 reads return the same value for REG_FEIMID.
The same issue was seen on ATmega328P and ATSAM 3X8E (Arduino DUE), 3 seperate SX1278 modules were tried.</p>

<p>Not sure if there is a fix for this.</p>


  </div><a class="u-url" href="/2020/06/11/LoRa-receiver-automatic-frequency-control.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
        <ul class="contact-list">
          
        </ul>
      </div>
      <div class="footer-col">
        <p>Adventures with Semtech LoRa devices</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"></ul>
</div>

  </div>

</footer>
</body>

</html>
